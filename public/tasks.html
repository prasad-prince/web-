<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tasks - Study Tracker</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      transition: background 0.3s ease;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    .tasks-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .tasks-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
      transition: all 0.3s ease;
      animation: fadeIn 0.6s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    body.dark-mode .tasks-card {
      background: #2d2d2d;
      color: #f0f0f0;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .add-task-form {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      animation: fadeIn 0.8s ease;
    }
    body.dark-mode .add-task-form {
      background: #3d3d3d;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      animation: fadeIn 1s ease;
      border-left: 5px solid #ddd;
    }
    .task-item:hover {
      transform: translateX(5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .task-item.priority-high { border-left-color: #ff4444; }
    .task-item.priority-medium { border-left-color: #ff9800; }
    .task-item.priority-low { border-left-color: #4CAF50; }
    .task-item.status-done {
      opacity: 0.7;
      text-decoration: line-through;
    }
    body.dark-mode .task-item {
      background: #3d3d3d;
      color: white;
    }
    .task-content {
      flex: 1;
      margin-right: 15px;
    }
    .task-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    body.dark-mode .task-title {
      color: #f0f0f0;
    }
    .task-meta {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
    body.dark-mode .task-meta {
      color: #aaa;
    }
    .priority-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .priority-high { background: #ffebee; color: #c62828; }
    .priority-medium { background: #fff3e0; color: #e65100; }
    .priority-low { background: #e8f5e9; color: #2e7d32; }
    body.dark-mode .priority-high { background: #5a2a2a; color: #ff6b6b; }
    body.dark-mode .priority-medium { background: #5a3a2a; color: #ffa726; }
    body.dark-mode .priority-low { background: #2a5a2a; color: #66bb6a; }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-done { background: #e8f5e9; color: #2e7d32; }
    body.dark-mode .status-pending { background: #5a3a2a; color: #ffa726; }
    body.dark-mode .status-done { background: #2a5a2a; color: #66bb6a; }
    .task-actions {
      display: flex;
      gap: 8px;
    }
    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    .btn-edit {
      background: #2196F3;
      color: white;
    }
    .btn-edit:hover {
      background: #1976D2;
      transform: scale(1.05);
    }
    .btn-delete {
      background: #ff4444;
      color: white;
    }
    .btn-delete:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .btn-toggle {
      background: #4CAF50;
      color: white;
    }
    .btn-toggle:hover {
      background: #388E3C;
      transform: scale(1.05);
    }
    .modal-content {
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body class="light-mode">
  <div class="tasks-container">
    <div class="tasks-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-tasks"></i> My Tasks</h2>
        <div>
          <a href="dashboard.html" class="btn btn-outline-primary me-2">
            <i class="fas fa-arrow-left"></i> Back
          </a>
          <button class="btn btn-outline-dark" onclick="toggleDarkMode()">
            <i class="fas fa-moon"></i> Dark Mode
          </button>
        </div>
      </div>

      <!-- Add Task Form -->
      <div class="add-task-form">
        <h4><i class="fas fa-plus-circle"></i> Add New Task</h4>
        <form id="addTaskForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Task Description</label>
              <input type="text" class="form-control" id="taskInput" placeholder="Enter your task..." required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Priority</label>
              <select class="form-control" id="priorityInput">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Deadline</label>
              <input type="date" class="form-control" id="deadlineInput">
            </div>
          </div>
          <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-plus"></i> Add Task
          </button>
        </form>
      </div>

      <!-- Tasks List -->
      <div id="tasksList">
        <h4><i class="fas fa-list"></i> Your Tasks</h4>
        <div id="tasksContainer">
          <!-- Tasks will be displayed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editTaskForm">
            <div class="mb-3">
              <label class="form-label">Task Description</label>
              <input type="text" class="form-control" id="editTaskInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Priority</label>
              <select class="form-control" id="editPriorityInput">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Deadline</label>
              <input type="date" class="form-control" id="editDeadlineInput">
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-control" id="editStatusInput">
                <option value="Pending">Pending</option>
                <option value="Done">Done</option>
              </select>
            </div>
            <input type="hidden" id="editTaskIndex">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveEditedTask()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      document.body.classList.toggle("light-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      const btn = document.querySelector('button[onclick="toggleDarkMode()"]');
      if (btn) {
        btn.innerHTML = isDark 
          ? '<i class="fas fa-sun"></i> Light Mode' 
          : '<i class="fas fa-moon"></i> Dark Mode';
      }
    }

    function loadTasks() {
      const token = localStorage.getItem("authToken");
      if (!token) {
        location.href = "login.html";
        return;
      }

      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      displayTasks(localTasks);
    }

    function displayTasks(tasks) {
      const container = document.getElementById('tasksContainer');
      
      if (tasks.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-4">No tasks yet. Add your first task above!</p>';
        return;
      }

      container.innerHTML = tasks.map((task, index) => {
        const taskObj = typeof task === 'object' ? task : { text: task, priority: 'medium', status: 'Pending', deadline: null };
        const priorityClass = `priority-${taskObj.priority || 'medium'}`;
        const statusClass = `status-${taskObj.status?.toLowerCase() || 'pending'}`;
        const deadline = taskObj.deadline ? new Date(taskObj.deadline).toLocaleDateString() : 'No deadline';
        const isOverdue = taskObj.deadline && new Date(taskObj.deadline) < new Date() && taskObj.status !== 'Done';
        
        return `
          <div class="task-item ${priorityClass} ${taskObj.status === 'Done' ? 'status-done' : ''} ${isOverdue ? 'border-warning' : ''}">
            <div class="task-content">
              <div class="task-title">${taskObj.text || task}</div>
              <div class="task-meta">
                <span class="priority-badge ${priorityClass}">${taskObj.priority || 'medium'}</span>
                <span class="status-badge ${statusClass}">${taskObj.status || 'Pending'}</span>
                <span><i class="fas fa-calendar"></i> ${deadline}</span>
                ${isOverdue ? '<span style="color: #ff4444;"><i class="fas fa-exclamation-triangle"></i> Overdue</span>' : ''}
              </div>
            </div>
            <div class="task-actions">
              <button class="btn-action btn-toggle" onclick="toggleTaskStatus(${index})" title="Toggle Status">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn-action btn-edit" onclick="editTask(${index})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-action btn-delete" onclick="deleteTask(${index})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function addTask() {
      const taskText = document.getElementById('taskInput').value.trim();
      const priority = document.getElementById('priorityInput').value;
      const deadline = document.getElementById('deadlineInput').value;
      
      if (!taskText) return;

      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      localTasks.push({
        text: taskText,
        priority: priority,
        status: 'Pending',
        deadline: deadline || null,
        createdAt: new Date().toISOString()
      });
      localStorage.setItem('userTasks', JSON.stringify(localTasks));
      loadTasks();
      document.getElementById('addTaskForm').reset();
    }

    function editTask(index) {
      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      const task = localTasks[index];
      const taskObj = typeof task === 'object' ? task : { text: task, priority: 'medium', status: 'Pending', deadline: null };
      
      document.getElementById('editTaskInput').value = taskObj.text || task;
      document.getElementById('editPriorityInput').value = taskObj.priority || 'medium';
      document.getElementById('editDeadlineInput').value = taskObj.deadline || '';
      document.getElementById('editStatusInput').value = taskObj.status || 'Pending';
      document.getElementById('editTaskIndex').value = index;
      
      const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
      modal.show();
    }

    function saveEditedTask() {
      const index = parseInt(document.getElementById('editTaskIndex').value);
      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      
      localTasks[index] = {
        text: document.getElementById('editTaskInput').value.trim(),
        priority: document.getElementById('editPriorityInput').value,
        status: document.getElementById('editStatusInput').value,
        deadline: document.getElementById('editDeadlineInput').value || null,
        createdAt: typeof localTasks[index] === 'object' ? localTasks[index].createdAt : new Date().toISOString()
      };
      
      localStorage.setItem('userTasks', JSON.stringify(localTasks));
      const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
      modal.hide();
      loadTasks();
    }

    function toggleTaskStatus(index) {
      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      const task = localTasks[index];
      const taskObj = typeof task === 'object' ? task : { text: task, priority: 'medium', status: 'Pending', deadline: null };
      
      taskObj.status = taskObj.status === 'Done' ? 'Pending' : 'Done';
      localTasks[index] = taskObj;
      localStorage.setItem('userTasks', JSON.stringify(localTasks));
      loadTasks();
    }

    function deleteTask(index) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      const localTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
      localTasks.splice(index, 1);
      localStorage.setItem('userTasks', JSON.stringify(localTasks));
      loadTasks();
    }

    window.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.body.classList.remove('light-mode');
        const btn = document.querySelector('button[onclick="toggleDarkMode()"]');
        if (btn) btn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
      }
      loadTasks();
    });

    document.getElementById('addTaskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      addTask();
    });
  </script>
</body>
</html>